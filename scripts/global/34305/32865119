<p>Hi I have doubt about <code>Sql server</code> </p>  <pre><code>table : Emp      Empid   | name |  Sdate        |  Flag | deptno | Deptname     1     |test  | 2015-09-18    |   2   |10      |Hr      1     |tes   | 2014-09-13    |   2   |10      |ceo     1     |hari  | 2015-09-14    |   2   |10      |Pm     1     |balu  | 2015-09-05    |   5   |10      |cm     1     |jai   | 2015-09-12    |   1   |20      |hr     2     |kali  |2015-09-15     |   2   |20      |Deo     2     |hni   |2015-09-04     |   5   |20      |br     3     |jai   |2015-09-10     |   3   |20      |ceo     3     |man   |2015-09-16     |   5   |20      |hal     4     |op    |2015-09-12     |   2   |10      |har     4     |jai   |2014-05-01     |   5   |10      |kal </code></pre>  <p>based on above table I want output like below</p>  <p>Here change <code>Flag</code> values, but here actually changing names, because <code>deptname</code> remains from the row with value 2 >compare records based on <code>empid+ deptno</code>  and the <code>sdate</code>  of <code>flag=2</code> and <code>sdate</code> of     <code>flag=5</code>, <code>sdate</code> should be less than or equal to <code>flag=2 sdate</code> and the difference     between the <code>sdates</code> should be less than 30 days.</p>  <pre><code>  Empid     | name   | Sdate         | Flag   | deptno  | deptname     1       | balu   | 2015-09-18    |   2    |10       |Hr     1       |jai     | 2015-09-12    |   1    |20       |Hr     2       |hni     |2015-09-15     |   2    |20       |Deo     3       |jai     |2015-09-10     |   3    |20       |ceo     3       |man     |2015-09-16     |   5    |20       |Hal     4       |op      |2015-09-12     |   2    |10       |har </code></pre>  <p>I Tried like below :</p>  <pre><code>SELECT distinct a1.[id]       ,isnull(a2.name,a1.name) as name,a1.flag,a1.deptno,a1.[sdate]  FROM [testresult].[dbo].[emp1] as a1 left join [testresult].[dbo].[emp1] as a2    on a1.id=a2.id    and a1.deptno=a2.deptno   and a1.[check] =2 and a2.[check]=5 and datediff(day,a2.sdate,a1.sdate)&lt;=30  where    not exists (select 1 from [testresult].[dbo].[emp1] as a3 where a3.id = a.id and  a3.deptno=a1.deptno   and a1.flag = 5 and a3.flag = 2) </code></pre>  <p>above query not give expected result . please tell me how to write query to achive this task in sql server </p>