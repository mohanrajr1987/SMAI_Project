<p>I need help on identifying a sequence of events in SQL Server 2008 R2 rows please:</p>  <p>This is the sample data with <a href="http://sqlfiddle.com/#!3/141eb3/2" rel="nofollow">SQLFiddle</a>:</p>  <pre><code>   ID   EventTime       TypeID             EventNr     1   06:34:51        1     2   06:35:51        3     3   06:36:51        40     4   06:37:51        10     5   06:48:51        1     6   06:49:51        2     7   06:50:51        4     8   06:51:51        40     9   06:52:51        5     10  06:53:51        10 </code></pre>  <p>I need help on identifying Event Nrs please -  Rules that I must follow:</p>  <p>A event starts start with TypeID 1 (@StartTypeID).</p>  <p>A event ends with TypeID 10 (@EndTypeID).</p>  <p>A event has a different TypeID after @StartTypeID, and before @EndTypeID.</p>  <p>and there must be more than 5 minutes between EventNrs</p>  <pre><code> ID EventTime   TypeID  Notes                                               EventNr 1   06:34:51    1       Starts with TypeID @StartID 1     (OK)                     1 2   06:35:51    3       Has different TypeID in sequence before @EndID reached(OK) 1 3   06:36:51    40                                                                 1     4   06:37:51    10      Ends with @EndID 10 + &gt;5min before next Event(OK EventEnd) 1  5   06:48:51    1       Starts with TypeID @StartID 1                              2 6   06:49:51    2       Has different TypeID in sequence before @EndID reached     2 7   06:50:51    4                                                                  2                     8   06:51:51    40                                                                 2 9   06:52:51    5       Has different TypeID in sequence before  @EndID reached    2 10  06:53:51    10      Ends with @EndID 10                                        2        declare @FirstTypeID int = 1  declare @LastTypeID int = 10   create table #T (ID int identity , EventTime datetime, TypeID int) insert into #T(EventTime,TypeID) values  (DATEADD(minute,-30,getdate()),1)  ,(DATEADD(minute,-29,getdate()),3)  ,(DATEADD(minute,-28,getdate()),40)  ,(DATEADD(minute,-27,getdate()),10)    ,(DATEADD(minute,-16,getdate()),1)  ,(DATEADD(minute,-15,getdate()),2)  ,(DATEADD(minute,-14,getdate()),4)  ,(DATEADD(minute,-13,getdate()),40)  ,(DATEADD(minute,-12,getdate()),5)   ,(DATEADD(minute,-11,getdate()),10)       select * from #T  drop table #T </code></pre>