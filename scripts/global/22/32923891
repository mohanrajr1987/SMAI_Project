<p>In my Yii project I need to search and sort data by some custom value. I have <code>'users'</code> table and I need every User instance to have <code>month_profit</code> property which should combine SQL data + lots of my own calculations. At the moment I have in my User model:</p>  <pre><code>public $month_profit;  public function search($pageSize = 10, $defaultOrder = '`t`.`reg_date` DESC') {     $criteria = new CDbCriteria;     $criteria-&gt;with = array('money');     $requests_table = Requests::model()-&gt;tableName();     $requests_count_sql = "(SELECT COUNT(*) FROM $requests_table rt WHERE rt.partner_id = t.id) ";      $referrals_table = Referrals::model()-&gt;tableName();     $referrals_count_sql = "(SELECT COUNT(*) FROM $referrals_table reft WHERE reft.user_id = t.id) ";     $referrals_payed_sql = "(SELECT COUNT(*) FROM $referrals_table reft WHERE reft.user_id = t.id AND reft.status = 'Оплачено') ";     //$month profit_sql = ???;      $criteria-&gt;select = array(         '*',         $requests_count_sql . "as requests_count",         $referrals_count_sql . "as referrals_count",         $referrals_payed_sql . "as referrals_payed_count",         $month_profit_sql . "as month_profit",     );      $criteria-&gt;compare($requests_count_sql, $this-&gt;requests_count);     $criteria-&gt;compare($referrals_count_sql, $this-&gt;referrals_count);     $criteria-&gt;compare($referrals_payed_sql, $this-&gt;referrals_payed_count);     $criteria-&gt;compare($month_profit_sql, $this-&gt;month_profit);      $criteria-&gt;compare('t.id', $this-&gt;id);     $criteria-&gt;compare('t.reg_date', $this-&gt;reg_date, true);     $criteria-&gt;compare('username', $this-&gt;username, true);     $criteria-&gt;compare('password', $this-&gt;password, true);     $criteria-&gt;compare('site', $this-&gt;site, true);     $criteria-&gt;compare('status', $this-&gt;status, true);      return new CActiveDataProvider(get_class($this), array(         'criteria' =&gt; $criteria,         'pagination' =&gt; array( 'pageSize' =&gt; $pageSize ),         'sort' =&gt; array(             'defaultOrder' =&gt; $defaultOrder,             'attributes' =&gt; array(                 'id' =&gt; array(                     'asc' =&gt; '`t`.`id` ASC',                     'desc' =&gt; '`t`.`id` DESC',                 ),                 'email' =&gt; array(                     'asc' =&gt; '`t`.`email` ASC',                     'desc' =&gt; '`t`.`email` DESC',                 ),                 'requests_count' =&gt; array(                     'asc' =&gt; 'requests_count ASC',                     'desc' =&gt; 'requests_count DESC',                 ),                 'referrals_count' =&gt; array(                     'asc' =&gt; 'referrals_count ASC',                     'desc' =&gt; 'referrals_count DESC',                 ),                 'referrals_payed_count' =&gt; array(                     'asc' =&gt; 'referrals_payed_count ASC',                     'desc' =&gt; 'referrals_payed_count DESC',                 ),                 'money' =&gt; array(                     'asc' =&gt; 'money.profit',                     'desc' =&gt; 'money.profit DESC',                 ),                 'fullProfit' =&gt; array(                     'asc' =&gt; 'money.full_profit',                     'desc' =&gt; 'money.full_profit DESC',                 ),                 '*',             ),         )     )); } </code></pre>  <p>E.g. I have a relation in my User model:</p>  <pre><code>public function relations() {     return array(         'clients' =&gt; array( self::HAS_MANY, 'Referrals', 'user_id'), </code></pre>  <p>Let's say my <code>month_profit</code> will be equal: count of User's <code>clients</code> registered in last 30 days * 150. I need to somehow pass this data to <code>search()</code> and create CDbCriteria to sort users by <code>month_profit</code>. Is this even real? :) Should I create another function to calculate everything and then pass to <code>search()</code>? All my tries followed to failure so far.</p>