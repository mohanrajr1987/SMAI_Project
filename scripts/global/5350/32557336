<p>I have the following input:</p>  <pre><code>&lt;root&gt;     &lt;output&gt;                      &lt;queries&gt;                 &lt;query name="name1"&gt;                     &lt;parameters&gt;                         &lt;parameter name="id_contact"&gt;8947&lt;/parameter&gt;                     &lt;/parameters&gt;                     &lt;queryResults/&gt;                 &lt;/query&gt;                 &lt;query name="name1"&gt;                     &lt;parameters&gt;                         &lt;parameter name="id_contact"&gt;8943&lt;/parameter&gt;                     &lt;/parameters&gt;                     &lt;queryResults&gt;                         &lt;record id="1"&gt;                             &lt;column name="id_task"&gt;16422&lt;/column&gt;                             &lt;column name="id_contact"&gt;8943&lt;/column&gt;                         &lt;/record&gt;                     &lt;/queryResults&gt;                 &lt;/query&gt;                 &lt;query name="name1"&gt;                     &lt;parameters&gt;                         &lt;parameter name="id_contact"&gt;1571&lt;/parameter&gt;                     &lt;/parameters&gt;                     &lt;queryResults/&gt;                 &lt;/query&gt;             &lt;/queries&gt;     &lt;/output&gt;     &lt;output2&gt;         &lt;output_getquerydata&gt;             &lt;data&gt;                 &lt;query name="name2"&gt;                     &lt;parameters&gt;                         &lt;parameter name="id"&gt;1&lt;/parameter&gt;                     &lt;/parameters&gt;                     &lt;queryResults&gt;                         &lt;record id="1"&gt;                             &lt;column name="id_task"&gt;14016&lt;/column&gt;                             &lt;column name="id_contact"&gt;8947&lt;/column&gt;                         &lt;/record&gt;                         &lt;record id="2"&gt;                             &lt;column name="id_task"&gt;14012&lt;/column&gt;                             &lt;column name="id_contact"&gt;8943&lt;/column&gt;                         &lt;/record&gt;                         &lt;record id="3"&gt;                             &lt;column name="id_task"&gt;8826&lt;/column&gt;                             &lt;column name="id_contact"&gt;1571&lt;/column&gt;                         &lt;/record&gt;                     &lt;/queryResults&gt;                 &lt;/query&gt;                 &lt;output_getquerydata&gt;                     &lt;queries&gt;                         &lt;query name="name3"&gt;                             &lt;parameters&gt;                                 &lt;parameter name="id_task"&gt;14016&lt;/parameter&gt;                                                          &lt;/parameters&gt;                             &lt;queryResults&gt;                                 &lt;record id="1"&gt;                                     &lt;column name="id_shift"&gt;2989&lt;/column&gt;                                 &lt;/record&gt;                             &lt;/queryResults&gt;                         &lt;/query&gt;                         &lt;query name="name3"&gt;                             &lt;parameters&gt;                                 &lt;parameter name="id_task"&gt;14012&lt;/parameter&gt;                             &lt;/parameters&gt;                             &lt;queryResults/&gt;                         &lt;/query&gt;                         &lt;query name="name3"&gt;                             &lt;parameters&gt;                                 &lt;parameter name="id_task"&gt;8826&lt;/parameter&gt;                                                           &lt;/parameters&gt;                             &lt;queryResults/&gt;                         &lt;/query&gt;                     &lt;/queries&gt;                 &lt;/output_getquerydata&gt;             &lt;/data&gt;         &lt;/output_getquerydata&gt;     &lt;/output2&gt; &lt;/root&gt; </code></pre>  <p>My XSL:</p>  <pre><code>&lt;xsl:strip-space elements="*"/&gt; &lt;xsl:key name="k" match="output/queries/query/queryResults/record" use="column[@name='id_contact']"/&gt; &lt;xsl:key name="ok" match="output2/output_getquerydata/data/query/queryResults/record" use="column[@name='id_task']"/&gt;     &lt;!-- identity transform --&gt; &lt;xsl:template match="@*|node()"&gt;     &lt;xsl:copy&gt;         &lt;xsl:apply-templates select="@*|node()"/&gt;     &lt;/xsl:copy&gt; &lt;/xsl:template&gt; &lt;!-- suppress the first output branch --&gt; &lt;xsl:template match="output"/&gt; &lt;!-- suppress records that have a matching entry in the other branch --&gt; &lt;xsl:template match="record[key('k', column[@name='id_contact'])]"/&gt; &lt;xsl:template match="parameters[not(key('ok', ./parameter))]"/&gt; </code></pre>  <p>The goal is for each 'query1' that has queryResults/record, I take the value from that queryResults/record/column[@name='id_contact'] and delete every record from "query2" that have that value in query2/queryResults/record/column[@name='id_contact']. This part works, but the next part doesn't work as it should : Then, after the values from query2 have been deleted, take the remaining query2/id_task values and keep the query[name3] that has the same value in id_task.</p>  <p>Desired output:</p>  <pre><code>&lt;root&gt;       &lt;output2&gt;         &lt;output_getquerydata&gt;             &lt;data&gt;                 &lt;query name="name2"&gt;                     &lt;parameters&gt;                         &lt;parameter name="id"&gt;1&lt;/parameter&gt;                     &lt;/parameters&gt;                     &lt;queryResults&gt;                         &lt;record id="1"&gt;                             &lt;column name="id_task"&gt;14016&lt;/column&gt;                             &lt;column name="id_contact"&gt;8947&lt;/column&gt;                         &lt;/record&gt;                          &lt;!--record no.22 deleted, because id_contact=8943 is a match in query1--&gt;                         &lt;record id="3"&gt;                             &lt;column name="id_task"&gt;8826&lt;/column&gt;                             &lt;column name="id_contact"&gt;1571&lt;/column&gt;                         &lt;/record&gt;                     &lt;/queryResults&gt;                 &lt;/query&gt;                 &lt;output_getquerydata&gt;                     &lt;queries&gt;                         &lt;query name="name3"&gt;                             &lt;parameters&gt;                                 &lt;parameter name="id_task"&gt;14016&lt;/parameter&gt;                                                          &lt;/parameters&gt;                             &lt;queryResults&gt;                                 &lt;record id="1"&gt;                                     &lt;column name="id_shift"&gt;2989&lt;/column&gt;                                 &lt;/record&gt;                             &lt;/queryResults&gt;                         &lt;/query&gt;                         &lt;!--2nd query name3 deleted, because id_task=14012 is not a match in remaining query2 values--&gt;                          &lt;query name="name3"&gt;                             &lt;parameters&gt;                                 &lt;parameter name="id_task"&gt;8826&lt;/parameter&gt;                                                           &lt;/parameters&gt;                             &lt;queryResults/&gt;                         &lt;/query&gt;                     &lt;/queries&gt;                 &lt;/output_getquerydata&gt;             &lt;/data&gt;         &lt;/output_getquerydata&gt;     &lt;/output2&gt; &lt;/root&gt; </code></pre>  <p>What am I doing wrong? Thank you</p>