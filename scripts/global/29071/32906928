<p>Imagine the following:</p>  <pre><code>{     "user" : "john",     "type" : "connect",     "created" : ISODate("2015-10-02T10:00:00.000Z"),     "__v" : 0 }, {     "user" : "john",     "type" : "disconnect",     "created" : ISODate("2015-10-02T10:10:00.000Z"),     "__v" : 0 }, {     "user" : "frank",     "type" : "connect",     "created" : ISODate("2015-10-02T10:05:00.000Z"),     "__v" : 0 }, {     "user" : "frank",     "type" : "disconnect",     "created" : ISODate("2015-10-02T10:15:00.000Z"),     "__v" : 0 }, {     "user" : "john",     "type" : "connect",     "created" : ISODate("2015-10-02T10:15:00.000Z"),     "__v" : 0 } </code></pre>  <p>I want to create an outage-report telling "user john had 5 minutes of downtime". I'm completely in the dark right now, I digged into aggregation aswell as mapReduce but nothing seems to point in the direction where I need it. I could solve it using plain javascript but I want to avoid that since MongoDB is so made for aggregation of those kinds. Maybe I'm just stuck in my head and need to let it rest for some while, but maybe someone has a good solution for me.</p>  <p>So best output would be (I guess):</p>  <pre><code>{     "user" : "john",     "outage": "5" } </code></pre>  <p>Besides this "optimal" example, there may be cases where disconnects are swallowed by the system when deploying a new server version. Those are about 10 seconds and I'm thinking about leaving them out for the sake of ease.</p>