<p>I'm trying to implement an email notifications feature. I have a notifications collection where each document has the following:</p>  <pre><code>{   userID: {type: ObjectId, index: true, required: true},   read: {type: Boolean, default: false, index: true},   emailed: {type: Boolean, default: false, index: true}, } </code></pre>  <p>I have a node <a href="https://github.com/ncb000gt/node-cron" rel="nofollow">CronJob</a> that once a day calls a function which is supposed to do the following (pseudocode):</p>  <pre><code>foreach (user)   db.notifications.find({     userID: user._id,     read: false,     emailed: false   }, function(e, notifications) {     set emailed to true     sendNotificationsEmail(user, notifications)   }); </code></pre>  <p>However I can't figure out a way to fetch the relevant notifications and mark them as "emailed" in an atomic way such that if this code is executing on multiple servers at the same time there won't be a race condition where the user receives multiple emails.</p>  <p>Any ideas?</p>