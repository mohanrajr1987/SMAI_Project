<p>I'm working with a large volume of XML files that have common elements repeated across them.  I've been able to concatenate them into a single file and sort using Xquery but I'm having difficulty taking the next step to merge elements based on key identifiers.  For example, I have an XML file with the following structure: </p>  <pre><code>&lt;example&gt;     &lt;Store ID="111"&gt;         &lt;Manager ID="123"&gt;             &lt;Employee&gt;                 &lt;EmployeeID&gt;0001001&lt;/EmployeeID&gt;                 &lt;HireDate Value="1-Jan-2000"/&gt;                 &lt;Action ID="001" Type="S"&gt;                     &lt;Details ID="a1"&gt;                         &lt;TransactionType&gt;I&lt;/TransactionType&gt;                     &lt;/Details&gt;                     &lt;TransactionType&gt;R&lt;/TransactionType&gt;                 &lt;/Action&gt;                 &lt;TransactionType&gt;R&lt;/TransactionType&gt;             &lt;/Employee&gt;             &lt;TransactionType&gt;R&lt;/TransactionType&gt;         &lt;/Manager&gt;         &lt;TransactionType&gt;R&lt;/TransactionType&gt;     &lt;/Store&gt;     &lt;Store ID="111"&gt;         &lt;Manager ID="123"&gt;             &lt;Employee&gt;                 &lt;EmployeeID&gt;0001001&lt;/EmployeeID&gt;                 &lt;HireDate Value="1-Jan-2000"/&gt;                 &lt;Action ID="003" Name="Ecg" Type="S"&gt;                     &lt;Details ID="b1"&gt;                         &lt;TransactionType&gt;I&lt;/TransactionType&gt;                     &lt;/Details&gt;                     &lt;TransactionType&gt;R&lt;/TransactionType&gt;                 &lt;/Action&gt;                 &lt;TransactionType&gt;R&lt;/TransactionType&gt;             &lt;/Employee&gt;             &lt;TransactionType&gt;R&lt;/TransactionType&gt;         &lt;/Manager&gt;         &lt;TransactionType&gt;R&lt;/TransactionType&gt;     &lt;/Store&gt;     &lt;Store ID="00102"&gt;         &lt;Manager ID="00302"&gt;             &lt;Employee&gt;                 &lt;EmployeeID&gt;0002001&lt;/EmployeeID&gt;                 &lt;Sex Value="M"/&gt;                 &lt;Confidential Birthdate="1970-07-03"/&gt;                 &lt;Action ID="003" Name="Ecg" Type="S"&gt;                     &lt;Details ID="c1"&gt;                         &lt;TransactionType&gt;I&lt;/TransactionType&gt;                     &lt;/Details&gt;                     &lt;TransactionType&gt;R&lt;/TransactionType&gt;                 &lt;/Action&gt;                 &lt;TransactionType&gt;R&lt;/TransactionType&gt;             &lt;/Employee&gt;             &lt;TransactionType&gt;R&lt;/TransactionType&gt;         &lt;/Manager&gt;         &lt;TransactionType&gt;R&lt;/TransactionType&gt;     &lt;/Store&gt; &lt;/example&gt; </code></pre>  <p>I would like to be able to merge the first 2 main Store elements based on attribute values of Store ID, Manager ID and the element value of EmployeeID, such that the resulting XML is as follows:</p>  <pre><code>&lt;example&gt;     &lt;Store ID="111"&gt;         &lt;Manager ID="123"&gt;             &lt;Employee&gt;                 &lt;EmployeeID&gt;0001001&lt;/EmployeeID&gt;                 &lt;HireDate Value="1-Jan-2000"/&gt;                 &lt;Action ID="001" Type="S"&gt;                     &lt;Details ID="a1"&gt;                         &lt;TransactionType&gt;I&lt;/TransactionType&gt;                     &lt;/Details&gt;                     &lt;TransactionType&gt;R&lt;/TransactionType&gt;                 &lt;/Action&gt;                 &lt;Action ID="003" Name="Ecg" Type="S"&gt;                     &lt;Details ID="b1"&gt;                         &lt;TransactionType&gt;I&lt;/TransactionType&gt;                     &lt;/Details&gt;                     &lt;TransactionType&gt;R&lt;/TransactionType&gt;                 &lt;/Action&gt;                 &lt;TransactionType&gt;R&lt;/TransactionType&gt;             &lt;/Employee&gt;             &lt;TransactionType&gt;R&lt;/TransactionType&gt;         &lt;/Manager&gt;         &lt;TransactionType&gt;R&lt;/TransactionType&gt;     &lt;/Store&gt;     &lt;Store ID="00102"&gt;         &lt;Manager ID="00302"&gt;             &lt;Employee&gt;                 &lt;EmployeeID&gt;0002001&lt;/EmployeeID&gt;                 &lt;Sex Value="M"/&gt;                 &lt;Confidential Birthdate="1970-07-03"/&gt;                 &lt;Action ID="003" Name="Ecg" Type="S"&gt;                     &lt;Details ID="c1"&gt;                         &lt;TransactionType&gt;I&lt;/TransactionType&gt;                     &lt;/Details&gt;                     &lt;TransactionType&gt;R&lt;/TransactionType&gt;                 &lt;/Action&gt;                 &lt;TransactionType&gt;R&lt;/TransactionType&gt;             &lt;/Employee&gt;             &lt;TransactionType&gt;R&lt;/TransactionType&gt;         &lt;/Manager&gt;         &lt;TransactionType&gt;R&lt;/TransactionType&gt;     &lt;/Store&gt; &lt;/example&gt; </code></pre>  <p>Any suggestions re: Xquery approaches to achieve this result would be greatly appreciated - or any alternative approaches as well (e.g. XSLT?).  Thanks!</p>