<p>I already successful implement a sync way, but how can I do it in async way?</p>  <p>Because there is no way to add parameter to winhttp callback.</p>  <pre><code>WINHTTP_STATUS_CALLBACK theCallback =     WinHttpSetStatusCallback     (     hSession,     (WINHTTP_STATUS_CALLBACK)HttpCallback,     WINHTTP_CALLBACK_FLAG_ALL_NOTIFICATIONS,     NULL     ); </code></pre>  <p>I tried save the lua_State as a variable and use it in HttpCallback, but it cause access violation.</p>  <p>here is my code:(not full code)</p>  <p>C</p>  <pre><code>static int callback_reference = 0; static lua_State *Ltemp; static int lua_registerCallback(lua_State *L)  {     callback_reference = luaL_ref(L, LUA_REGISTRYINDEX);     return 0; } void call_callback(lua_State* L)  {     lua_rawgeti(L, LUA_REGISTRYINDEX, callback_reference);     lua_pushstring(L, buf);     if (0 != lua_pcall(L, 1, 0, 0)) {        printf("Failed to call the callback!\n %s\n", lua_tostring(L, -1));        return;     } } void CALLBACK HttpCallback(HINTERNET hInternet, DWORD * dwContext, DWORD  dwInternetStatus, void * lpvStatusInformation, DWORD dwStatusInformationLength) {     //when done     call_callback(Ltemp); } static int doHttp(lua_State *L) {     Ltemp = L;     //init winhttp code here } </code></pre>  <p>lua</p>  <pre><code>function callback( result )     print("ok")     print(result) end lua_registerCallback(callback) doHttp("http://stackoverflow.com/") </code></pre>  <p><strong>EDIT:</strong> I also tried WinHttpSetOption and WinHttpQueryOption, but no luck.Am I did something wrong?</p>  <pre><code>//save L bool result = WinHttpSetOption(     hRequest,     WINHTTP_OPTION_CONTEXT_VALUE,     &amp;L,     sizeof(struct lua_State *)     );  //get L, but I think the L is broken here lua_State* L; bool result = WinHttpQueryOption(             hInternet,             WINHTTP_OPTION_CONTEXT_VALUE,             &amp;L,             sizeof(struct lua_State *)             ); </code></pre>