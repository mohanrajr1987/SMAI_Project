<p>I am trying to run <a href="https://code.google.com/p/android-test-kit/" rel="nofollow">Espresso</a> tests for an Android app. It works fine on a hardware device. When I run it on a freshly created <strong>AVD emulator</strong> it <strong>fails</strong> as shown here:</p>  <pre><code>:ExampleApp:connectedDebugAndroidTest  com.example.MainFragmentTest &gt; initializationError[Nexus_5_API_19(AVD) - 4.4.2]  FAILED      java.lang.NoClassDefFoundError: com/example/MainActivity     at java.lang.Class.getDeclaredFields(Native Method) :ExampleApp:connectedDebugAndroidTest FAILED  FAILURE: Build failed with an exception.  * What went wrong: Execution failed for task ':ExampleApp:connectedDebugAndroidTest'. &gt; There were failing tests. See the report at:  file:///home/user/work/ExampleApp/build/reports/androidTests/connected/index.html </code></pre>  <p>The HTML report contains the following stacktrace:</p>  <pre><code>java.lang.NoClassDefFoundError: com/example/MainActivity at java.lang.Class.getDeclaredFields(Native Method) at java.lang.Class.getDeclaredFields(Class.java:610) at org.junit.runners.model.TestClass.getSortedDeclaredFields(TestClass.java:77) at org.junit.runners.model.TestClass.scanAnnotatedMembers(TestClass.java:70) at org.junit.runners.model.TestClass.&lt;init&gt;(TestClass.java:57) at org.junit.runners.ParentRunner.createTestClass(ParentRunner.java:88) at org.junit.runners.ParentRunner.&lt;init&gt;(ParentRunner.java:83) at org.junit.runners.BlockJUnit4ClassRunner.&lt;init&gt;(BlockJUnit4ClassRunner.java:65) at android.support.test.internal.runner.junit4.AndroidJUnit4ClassRunner.&lt;init&gt;(AndroidJUnit4ClassRunner.java:38) at android.support.test.runner.AndroidJUnit4.&lt;init&gt;(AndroidJUnit4.java:36) at java.lang.reflect.Constructor.constructNative(Native Method) at java.lang.reflect.Constructor.newInstance(Constructor.java:423) at android.support.test.internal.runner.junit4.AndroidAnnotatedBuilder.buildAndroidRunner(AndroidAnnotatedBuilder.java:57) at android.support.test.internal.runner.junit4.AndroidAnnotatedBuilder.runnerForClass(AndroidAnnotatedBuilder.java:45) at org.junit.runners.model.RunnerBuilder.safeRunnerForClass(RunnerBuilder.java:59) at org.junit.internal.builders.AllDefaultPossibilitiesBuilder.runnerForClass(AllDefaultPossibilitiesBuilder.java:26) at org.junit.runner.Computer.getRunner(Computer.java:40) at org.junit.runner.Computer$1.runnerForClass(Computer.java:31) at org.junit.runners.model.RunnerBuilder.safeRunnerForClass(RunnerBuilder.java:59) at org.junit.runners.model.RunnerBuilder.runners(RunnerBuilder.java:101) at org.junit.runners.model.RunnerBuilder.runners(RunnerBuilder.java:87) at org.junit.runners.Suite.&lt;init&gt;(Suite.java:81) at org.junit.runner.Computer.getSuite(Computer.java:28) at android.support.test.internal.runner.TestRequestBuilder.classes(TestRequestBuilder.java:701) at android.support.test.internal.runner.TestRequestBuilder.build(TestRequestBuilder.java:664) at android.support.test.runner.AndroidJUnitRunner.buildRequest(AndroidJUnitRunner.java:329) at android.support.test.runner.AndroidJUnitRunner.onStart(AndroidJUnitRunner.java:226) at android.app.Instrumentation$InstrumentationThread.run(Instrumentation.java:1701)  Caused by: java.lang.ClassNotFoundException: Didn't find class    "com.example.MainActivity" on path: DexPathList[[zip file    "/system/framework/android.test.runner.jar", zip file    "/data/app/com.example.debug.test-1.apk", zip file    "/data/app/com.example.debug-1.apk"],   nativeLibraryDirectories=[/data/app-lib/com.example.debug.test-1,    /data/app-lib/com.example.debug-1, /vendor/lib, /system/lib]] at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:56) at java.lang.ClassLoader.loadClass(ClassLoader.java:497) at java.lang.ClassLoader.loadClass(ClassLoader.java:457) ... 28 more </code></pre>  <p>I am basically following the structure in <a href="https://github.com/googlesamples/android-testing/blob/master/ui/espresso/BasicSample/app/src/androidTest/java/com/example/android/testing/espresso/BasicSample/ChangeTextBehaviorTest.java" rel="nofollow">espresso/BasicSample/ChangeTextBehaviorTest.java</a>. This test <strong>works</strong> on the emulator!</p>  <p>For my test I could boil it down that running the test already <strong>fails</strong> when I just use the following code:</p>  <pre><code>@RunWith(AndroidJUnit4.class) public class MainFragmentTest {      @Rule     public ActivityTestRule&lt;MainActivity&gt; mActivityRule =          new ActivityTestRule&lt;&gt;(MainActivity.class);     } </code></pre>  <p>Here is the complete test class:</p>  <pre><code>import org.junit.Before; import org.junit.Rule; import org.junit.Test; import org.junit.runner.RunWith;  import android.support.test.rule.ActivityTestRule; import android.support.test.runner.AndroidJUnit4;  import com.example.R;  import static android.support.test.espresso.Espresso.onView; import static android.support.test.espresso.assertion.ViewAssertions.matches; import static android.support.test.espresso.matcher.ViewMatchers.withId; import static android.support.test.espresso.matcher.ViewMatchers.withText;  @RunWith(AndroidJUnit4.class) public class MainFragmentTest {      @Rule     public ActivityTestRule&lt;MainActivity&gt; mActivityRule =          new ActivityTestRule&lt;&gt;(MainActivity.class);      MainActivity mMainActivity;      MainFragment mMainFragment;      @Before     public void setUp() {         mMainActivity = mActivityRule.getActivity();         mMainFragment = (MainFragment) mMainActivity                 .getSupportFragmentManager()                 .findFragmentByTag(MainFragment.FRAGMENT_TAG);     }      @Test     public void testHeadline() {         onView(withId(R.id.headline)).check(matches(withText(R.string.headline)));     } } </code></pre>  <p>I am currently using the following tool chain:</p>  <ul> <li>com.android.tools.build:gradle:1.4.0-beta2</li> <li>buildToolsVersion "23.0.1"</li> <li>compileSdkVersion 22</li> <li>targetSdkVersion 22</li> <li>Gradle wrapper 2.5</li> <li>java version "1.7.0_79" OpenJDK</li> </ul>