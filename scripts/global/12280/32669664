<p>I have a strange issue when i try create an eventhandler in the run block. It is a bit hard to explain the issue, partly becaues I don't understand what's happening but I will do my best. It's written in typescript.</p>  <p>I have the following run-block:</p>  <pre><code>angular.module("myapp")   .run(($rootScope, StateChangeStartHandler) =&gt; {     $rootScope.$on("$stateChangeStart", StateChangeStartHandler.handler);   }); </code></pre>  <p>StateChangeStartHandler is a simple angular service with a function called handler which is meant to handle the $stateChangeStart event. The handler service looks like this:</p>  <pre><code>class StateChangeStartHandler {    private AuthService;   private $rootScope;   private AUTH_EVENTS;    constructor(AuthService, $rootScope, AUTH_EVENTS              // Everything breaks if I comment in the following line              //, $state              ) {     this.AuthService = AuthService;     this.$rootScope = $rootScope;     this.AUTH_EVENTS = AUTH_EVENTS;   }    handler(event, next) {     if (!this.AuthService.isLoggedIn() &amp;&amp; next.name != "root.login") {       event.preventDefault();       this.$rootScope.$broadcast(this.AUTH_EVENTS.notAuthenticated);     }   } }  angular.module("myapp")   .service("StateChangeStartHandler", StateChangeStartHandler); </code></pre>  <p>I was implementing this using TDD. I wrote a test that verified if go was called on $state. When i then went into the class to implement it, i faced the issue. When I injected $state in the StateChangeStartHandler, suddenly all tests using $rootScope.$apply() said AuthService.isLoggedIn is not a function.</p>  <p>I suspect that $rootScope.$apply() triggers a $stateChangeStart, and then something strange happens.</p>  <p><strong>UPDATE 1:</strong> An example of a seemingly unrelated test that suddenly fails:</p>  <pre><code>Chrome 45.0.2454 (Mac OS X 10.10.5) Authentication service login(email, password) should be defined FAILED     TypeError: this.AuthService.isLoggedIn is not a function         at StateChangeStartHandler.handler (/Users/blacksails/repos/avalonia/priv/static/js/app.js:305:31)         at Scope.$broadcast (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:16311:28)         at Object.transitionTo (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:50779:24)         at Array.&lt;anonymous&gt; (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:49896:18)         at Object.invoke (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:4584:17)         at handleIfMatch (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:49386:28)         at /Users/blacksails/repos/avalonia/priv/static/js/libraries.js:49441:18         at check (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:49557:23)         at update (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:49566:13)         at Scope.$broadcast (/Users/blacksails/repos/avalonia/priv/static/js/libraries.js:16311:28) </code></pre>