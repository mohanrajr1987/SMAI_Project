<pre><code>DECLARE @userId INT = 1001  SELECT      , Logins.IP     , COUNT(LoginsOther.UserId) AS OtherUsersOnThisIp     , MAX(Logins.DateHappened) AS LastUsed     , Logins.UserId FROM Security.UserLogin AS Logins  LEFT JOIN Security.UserLogin AS LoginsOther    ON LoginsOther.IP = Logins.IP   AND LoginsOther.UserId &lt;&gt; Logins.UserId  WHERE Logins.UserId = @userId GROUP BY      , Logins.IP     , Logins.UserId </code></pre>  <p>So, I have Table UserLogin with columns: <code>Id int, DateHappened datetime, IP nvarchar, LoginStatusId int, UserId bigint</code> there are 17769 records in this table. The task is to take used IP adresses by user and <code>OtherUsersOnThisIp</code> must show other user count used this IpAddress, when I run query Result count is 22 rows but it takes 10-19 seconds.  Are there any ways to optimize this query run faster?</p>