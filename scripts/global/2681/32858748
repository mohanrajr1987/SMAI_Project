<p>Following table, top few lines for operational status of a device, every poll:</p>  <p><code>samplevalue = 2</code> is operational status down, <code>samplevalue = 1</code> is operational status up</p>  <pre><code>source          target                                              sampletime      samplevalue ------------------------------------------------------------------------------------------------ 128.42.196.11   Se2/0/2(Serial2/0/2)                                9/30/15 11:10   2 128.42.196.11   Fa3/0/0(FastEthernet3/0/0)                          9/30/15 11:10   1 128.42.196.11   Gi1/0/0.10(GigabitEthernet1/0/0.10)                 9/30/15 11:10   1 128.42.196.11   Se2/0/2.305(Serial2/0/2.305)                        9/30/15 11:10   2 128.42.196.11   Se2/0/2.309(Serial2/0/2.309)                        9/30/15 11:10   2 128.42.196.11   Gi1/0/0.20(GigabitEthernet1/0/0.20)                 9/30/15 11:10   1 128.42.196.11   Se2/0/2.300(Serial2/0/2.300)                        9/30/15 11:10   2 128.42.196.11   Gi0/0/0(GigabitEthernet0/0/0)                       9/30/15 11:10   1 128.42.196.11   Se2/0/2.306(Serial2/0/2.306)                        9/30/15 11:10   2 128.42.196.11   PO2/1/0(POS2/1/0--SONET/SDH Medium/Section/Line)    9/30/15 11:09   2 128.42.196.11   Tu10(Tunnel10-mpls layer)                           9/30/15 11:09   2 128.42.196.11   Tu4(Tunnel4)                                        9/30/15 11:09   2 128.42.196.11   Gi1/0/0.40(GigabitEthernet1/0/0.40)                 9/30/15 11:09   1 128.42.196.11   Se2/0/1(Serial2/0/1)                                9/30/15 11:09   1 128.42.196.11   Gi1/0/0.20(GigabitEthernet1/0/0.20)                 9/30/15 11:09   1 128.42.196.11   Tu10(Tunnel10)                                      9/30/15 11:08   2 128.42.196.11   Se2/0/0(Serial2/0/0)                                9/30/15 11:08   1 128.42.196.11   Se2/0/2.309(Serial2/0/2.309)                        9/30/15 11:08   2 128.42.196.11   Se2/0/2.306(Serial2/0/2.306)                        9/30/15 11:08   2 </code></pre>  <p>From above table we have to calculate how much time a particular interface of a device is with <code>sampletime = 1</code> and with <code>sampletime = 2</code> and that too only latest condition of interface.</p>  <p>I could able to work on following query:</p>  <pre><code>with temp as (      select          p.source,          p.target,          p.samplevalue,         p.sampletime,         lag(p.samplevalue,1) over (order by p.source, p.target, p.sampletime desc) as newvalue,         lag(p.sampletime,1) over (order by p.source, p.target, p.sampletime desc) as changedat      from INTERFACE_OPERSTATUS p  ) select *  from(      select         ROW_NUMBER() over (partition by source, target order by source, target, changedat desc) as therow,         source,         target,         samplevalue as oldvalue,         newvalue,         changedat,         DATEDIFF(MINUTE,changedat,GETDATE()) as time     FROM temp      where          newvalue &lt;&gt; samplevalue         and newvalue = 2 ) a  where therow &gt;= 1 </code></pre>  <p>Problem with above query is:</p>  <ol> <li>Even though link is up, it shows still in outage</li> <li>Not able to consider latest link up condition</li> <li>Need outage time between link down and link up (not able to consider link up)</li> </ol>