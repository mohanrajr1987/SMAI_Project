<p>I have a table (created using the XSL document supplied below). I need to obtain the average data for each months temperature(min &amp; max) and rainfall.</p>  <p>I have started this but I've made a mess of the template and was wondering if someone can have a look? I'm getting a heap of repeated captions that I don't think should be there and I'm not having any luck pulling the data together yet.</p>  <p>XSL Document:</p>  <pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;  &lt;!--     Document   : weather.xsl     Created on : September 30, 2015, 5:37 PM     Author     : rory     Description:         Purpose of transformation follows. --&gt;  &lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"&gt;     &lt;xsl:output method="html"/&gt;      &lt;xsl:variable name="year" select="2015"/&gt;     &lt;xsl:variable name="x" select="//measurement[@year=$year]"/&gt;     &lt;xsl:variable name="monthsOfYear" select="$x[@day=1]/month"/&gt;     &lt;xsl:variable name="daysOfMonth" select="$x[@month=1]/day"/&gt;     &lt;xsl:variable name="highestRainfall" select="$x/rainfall[.!=''][not( . &amp;lt; $x/rainfall)]"/&gt;     &lt;xsl:variable name="highestMinTemp" select="$x/temperature[@type='minimum' and .!=''][not( . &amp;lt; $x/temperature[@type='minimum'])]" /&gt;     &lt;xsl:variable name="lowestMinTemp" select="$x/temperature[@type='minimum' and .!=''][not( $x/temperature[@type='minimum']  &amp;lt; . )]" /&gt;     &lt;xsl:variable name="highestMaxTemp" select="$x/temperature[@type='maximum' and .!=''][not( . &amp;lt; $x/temperature[@type='maximum'])]" /&gt;     &lt;xsl:variable name="lowestMaxTemp" select="$x/temperature[@type='maximum' and .!=''][not( $x/temperature[@type='maximum']  &amp;lt; . )]" /&gt;     &lt;xsl:variable name="highestSolar" select="$x/solar[.!=''][not( . &amp;lt; $x/solar)]"/&gt;      &lt;!-- TODO customize transformation rules           syntax recommendation http://www.w3.org/TR/xslt      --&gt;     &lt;xsl:template match="/"&gt;         &lt;html&gt;             &lt;head&gt;                 &lt;title&gt;Formatted Weather Outputs (Question 6)&lt;/title&gt;                  &lt;style&gt;                     .odd{                         background: lightgreen;                     }                     .even{                         background: violet;                     }                     .negative{                         color: red;                     }                 &lt;/style&gt;             &lt;/head&gt;             &lt;body&gt;                 &lt;table border="1" style="text-align:center;border-collapse:collapse;"&gt;                     &lt;xsl:apply-templates select="weather" /&gt;                 &lt;/table&gt;                 &lt;table border="1" style="text-align:center;border-collapse:collapse;"&gt;                     &lt;xsl:apply-templates select="weather/measurement[@year='2015']" /&gt;                 &lt;/table&gt;             &lt;/body&gt;         &lt;/html&gt;     &lt;/xsl:template&gt;      &lt;xsl:template match="weather"&gt;         &lt;caption&gt;Daily Observations&lt;/caption&gt;             &lt;tr&gt;                 &lt;th&gt;Date (DD/MM/YYYY)&lt;/th&gt;                 &lt;th&gt;Min Temp (&lt;sup&gt;o&lt;/sup&gt;C)&lt;/th&gt;                 &lt;th&gt;Max Temp (&lt;sup&gt;o&lt;/sup&gt;C)&lt;/th&gt;                 &lt;th&gt;Solar Radiation (kwh/m&lt;sup&gt;2&lt;/sup&gt;)&lt;/th&gt;                 &lt;th&gt;Rainfall (mm)&lt;/th&gt;             &lt;/tr&gt;              &lt;!-- Only display dates for 2015 --&gt;             &lt;xsl:for-each select="measurement[@year='2015']"&gt;                 &lt;tr&gt;                     &lt;xsl:attribute name="class"&gt;                         &lt;xsl:choose&gt;                             &lt;xsl:when test="(@month mod 2 != 0)"&gt;odd&lt;/xsl:when&gt;                             &lt;xsl:otherwise&gt;even&lt;/xsl:otherwise&gt;                         &lt;/xsl:choose&gt;                     &lt;/xsl:attribute&gt;                      &lt;td&gt;                         &lt;xsl:value-of select="concat(@day, '/', @month, '/', @year)" /&gt;                     &lt;/td&gt;                     &lt;td&gt;                         &lt;xsl:attribute name="class"&gt;                             &lt;xsl:choose&gt;                                 &lt;xsl:when test="temperature[@type='minimum'] &amp;lt; 0"&gt;negative&lt;/xsl:when&gt;                             &lt;/xsl:choose&gt;                         &lt;/xsl:attribute&gt;                         &lt;xsl:if test=" temperature[@type='minimum'] = $highestMinTemp"&gt;                             &lt;xsl:attribute name="style"&gt;background-color:gold&lt;/xsl:attribute&gt;                         &lt;/xsl:if&gt;                         &lt;xsl:if test=" temperature[@type='minimum'] = $lowestMinTemp"&gt;                             &lt;xsl:attribute name="style"&gt;background-color:lightblue&lt;/xsl:attribute&gt;                         &lt;/xsl:if&gt;                         &lt;xsl:value-of select="temperature[@type='minimum']" /&gt;                     &lt;/td&gt;                     &lt;td&gt;                         &lt;xsl:if test=" temperature[@type='maximum'] = $highestMaxTemp"&gt;                             &lt;xsl:attribute name="style"&gt;background-color:gold&lt;/xsl:attribute&gt;                         &lt;/xsl:if&gt;                         &lt;xsl:if test=" temperature[@type='maximum'] = $lowestMaxTemp"&gt;                             &lt;xsl:attribute name="style"&gt;background-color:lightblue&lt;/xsl:attribute&gt;                         &lt;/xsl:if&gt;                             &lt;xsl:value-of select="temperature[@type='maximum']" /&gt;                                                        &lt;/td&gt;                     &lt;td&gt;                         &lt;xsl:if test=" solar = $highestSolar"&gt;                             &lt;xsl:attribute name="style"&gt;background-color:gold&lt;/xsl:attribute&gt;                         &lt;/xsl:if&gt;                         &lt;xsl:value-of select="solar"/&gt;                     &lt;/td&gt;                     &lt;td&gt;                         &lt;xsl:if test=" rainfall = $highestRainfall"&gt;                             &lt;xsl:attribute name="style"&gt;background-color:gold&lt;/xsl:attribute&gt;                         &lt;/xsl:if&gt;                         &lt;xsl:value-of select="rainfall" /&gt;                     &lt;/td&gt;                 &lt;/tr&gt;             &lt;/xsl:for-each&gt;     &lt;/xsl:template&gt;      &lt;xsl:template match="weather/measurement"&gt;         &lt;xsl:variable name="totalMinTemp" select="sum(temperature[@type='minimum'])" /&gt;         &lt;xsl:variable name="numberOfDays" select="count(temperature[@type='minimum'])" /&gt;         &lt;xsl:variable name="averageMinTemp" select="($totalMinTemp div $numberOfDays)" /&gt;         &lt;xsl:variable name="month" select="@month" /&gt;         &lt;caption&gt;Monthly Averages&lt;/caption&gt;             &lt;tr&gt;&lt;td colspan="4"&gt;Average&lt;/td&gt;&lt;/tr&gt;             &lt;tr&gt;                 &lt;td&gt;Month&lt;/td&gt;&lt;td&gt;Min Temp&lt;sup&gt;o&lt;/sup&gt;C&lt;/td&gt;&lt;td&gt;Max Temp&lt;sup&gt;o&lt;/sup&gt;C&lt;/td&gt;&lt;td&gt;Solar radiation kwh/m&lt;sup&gt;2&lt;/sup&gt;&lt;/td&gt;             &lt;/tr&gt;             &lt;tr&gt;                 &lt;td&gt;&lt;!--&lt;xsl:value-of select="$month" /&gt;--&gt;T&lt;/td&gt;             &lt;/tr&gt;      &lt;/xsl:template&gt;  &lt;/xsl:stylesheet&gt; </code></pre>  <p>Input document sample:</p>  <pre><code>&lt;weather&gt;     &lt;measurement year="2015" month="09" day="19"&gt;         &lt;rainfall&gt;0.0&lt;/rainfall&gt;         &lt;temperature type="minimum"&gt;5.2&lt;/temperature&gt;         &lt;temperature type="maximum"&gt;19.9&lt;/temperature&gt;         &lt;solar&gt;5.0&lt;/solar&gt;     &lt;/measurement&gt;     &lt;measurement year="2015" month="09" day="20"&gt;         &lt;rainfall&gt;0.0&lt;/rainfall&gt;         &lt;temperature type="minimum"&gt;5.3&lt;/temperature&gt;         &lt;temperature type="maximum"&gt;22.7&lt;/temperature&gt;         &lt;solar&gt;5.3&lt;/solar&gt;     &lt;/measurement&gt;     &lt;measurement year="2015" month="09" day="21"&gt;         &lt;rainfall&gt;0.0&lt;/rainfall&gt;         &lt;temperature type="minimum"&gt;6.9&lt;/temperature&gt;         &lt;temperature type="maximum"&gt;17.6&lt;/temperature&gt;         &lt;solar&gt;3.8&lt;/solar&gt;     &lt;/measurement&gt; &lt;/weather&gt; </code></pre>