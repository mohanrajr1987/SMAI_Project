<p>I have an angular phonegap app that I want to expand to use the window.openDatabase to access the local mobile database.</p>  <p>I am trying to unit test the code that creates/opens the database and I am running in to some problems.</p>  <p>I have a factory:</p>  <pre><code>'use strict';  angular.module('data')   .factory('localStore', ['$window',     function ($window){       var _db;          function _populate(tx){           tx.executeSQL('CREATE TABLE IF NOT EXISTS TEST(id unique, description)');         }          function _error(err){           console.log('Error populating DB: ' + err.code);         }          function _success(){           console.log('DB populate successful');         }          function _initialise(){           if ('undefined' === typeof _db){             _db = $window.openDatabase("Database", "1.0", "My App", 100000);             _db.transaction(_populate, _error, _success);           }         }        return {initialise: _initialise};     }]); </code></pre>  <p>As well as a jasmine test:</p>  <pre><code>'use strict';  describe('localStore', function() {   var localStore, $window, txnspy, mockspy;    beforeEach(module('data'));    beforeEach(function(){     txnspy = jasmine.createSpy('spy');      inject(function(_localStore_, _$window_){       localStore = _localStore_;       $window = _$window_;        $window.openDatabase =         function(db, version, name, size){           // throw(new Error('Local open'));           return {               transaction: function(txnFn){                   txnFn({executeSql: txnspy});             }           };         };        mockspy = spyOn($window, 'openDatabase');     });   });    it('initialise defined', function(){     expect(localStore.initialise).toBeDefined();   });    it('openDatabase', function(){       localStore.initialise();       expect(mockspy).toHaveBeenCalled();       expect(txnspy).toHaveBeenCalled();       expect(txnspy.calls.first().args[0]).toMatch(/^CREATE TABLE IF NOT EXISTS/);   }); }); </code></pre>  <p>And when run I get the error:</p>  <pre><code>    ERROR [PhantomJS 1.9.8 (Linux 0.0.0) | localStore | openDatabase]: TypeError: 'undefined' is not an object (evaluating '_db.transaction')     at _initialise (http://0.0.0.0:8081/base/app/scripts/data/localStore.js?15494938407287b8b9ee539800f7a42ae33c9b79:9)     at http://0.0.0.0:8081/base/test/spec/data/localStore.js?7bcca70e4f2dd2473ec1ddb5d521f37ac7f4b423:43 </code></pre>  <p>Can anyone see why _db is undefined following the call to $window.openDatabase?</p>  <p>UPDATE:</p>  <p>The problem was the spy. If I remove mockspy = spyOn($window, 'openDatabase'); and change the test to access a boolean variable set inside the mocked function, everything works as per normal!</p>