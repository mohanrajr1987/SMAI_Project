<p>I have a controller action with something like: </p>  <pre><code>    @widget = Widget.new(permitted_params)     @widget.user_id = current_user.id      if @widget.save       @widget     else       { errors: @widget.errors.full_messages }     end </code></pre>  <p>And I'm trying to create a spec for that controller. </p>  <pre><code>widget = mock_model(Widget)  allow(Widget).to receive(:new).and_return(widget) allow(widget).to receive(:user_id).and_return(widget) allow(widget).to receive(:save).and_return(true)  expect(widgets).to receive(:build) expect(widget).to receive(:save) post '/v2/widgets', name: 'foo' expect(json_response).to eq widget.as_json </code></pre>  <p>Now the weird thing that I'm getting : </p>  <pre><code> Failure/Error: post '/v2/widgets', name: 'foo'    #&lt;Double "Widget_1133"&gt; received unexpected message :user_id= with (1129) </code></pre>  <p>Even when I have </p>  <pre><code>allow(widget).to receive(:user_id).and_return(widget) </code></pre>  <p>Any help what is the mistake i'm doing? </p>  <p>Thanks </p>