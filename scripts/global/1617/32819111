<p>I am working on a windows device manager which will work with java.  I stick on trying to pass without error SetupDiSetClassInstallParams function. (I am trying disable an device.)</p>  <p>I am running exact same structure(necessary way) in C++ and I do not have any problem.</p>  <p>I am getting ERROR_INVALID_USER_BUFFER error. When I tried get this error in C++ I need to change SP_PROPCHANGE_PARAMS structs values with wrong ones.</p>  <p>My struct declerations:</p>  <pre><code>    public static class SP_CLASSINSTALL_HEADER extends Structure {      public static class ByReference extends SP_CLASSINSTALL_HEADER implements Structure.ByReference {         public ByReference() {         }          public ByReference(Pointer memory) {             super(memory);         }     }      public SP_CLASSINSTALL_HEADER() {         cbSize = size();     }      public SP_CLASSINSTALL_HEADER(Pointer memory) {         super(memory);         read();     }      public int cbSize;     public long InstallFunction; **/* &lt;-- this should be int or else buffer size changes, dll cannot place variables on right places. */**      protected List getFieldOrder() {         return Arrays.asList(new String[] { "cbSize", "InstallFunction" });     } }  public static class SP_PROPCHANGE_PARAMS extends Structure {      public static class ByReference extends SP_PROPCHANGE_PARAMS implements Structure.ByReference {         public ByReference() {         }          public ByReference(Pointer memory) {             super(memory);         }     }      public SP_PROPCHANGE_PARAMS() {     }      public SP_PROPCHANGE_PARAMS(Pointer memory) {         super(memory);         read();     }      public SP_CLASSINSTALL_HEADER ClassInstallHeader = new SP_CLASSINSTALL_HEADER();     public int StateChange;     public int Scope;     public int HwProfile;      protected List getFieldOrder() {         return Arrays.asList(new String[] { "ClassInstallHeader", "StateChange", "Scope", "HwProfile" });     } } </code></pre>  <p>My function decleration:</p>  <pre><code>boolean SetupDiSetClassInstallParams(WinNT.HANDLE hDevInfo, Pointer deviceInfoData, Pointer classInstallHeader, int size); </code></pre>  <p>How do I calling this function:</p>  <pre><code>    SP_PROPCHANGE_PARAMS spPropChangeParams = new SP_PROPCHANGE_PARAMS();      spPropChangeParams.ClassInstallHeader.InstallFunction = DISetupApi.DIF_PROPERTYCHANGE;     spPropChangeParams.Scope = DISetupApi.DICS_FLAG_GLOBAL;     spPropChangeParams.HwProfile = 0;     spPropChangeParams.StateChange = DISetupApi.DICS_DISABLE;     int spPropChangeParamsSize = spPropChangeParams.size();     SP_CLASSINSTALL_HEADER classInstallHeaderReference = new SP_CLASSINSTALL_HEADER(spPropChangeParams.getPointer());      setupApi.SetupDiSetClassInstallParams(hDevInfo, device.getSPDeviceInfoData().getPointer(), classInstallHeaderReference.getPointer(),             spPropChangeParamsSize); </code></pre>  <p>How It works in c++:</p>  <pre><code>SP_PROPCHANGE_PARAMS spPropChangeParams;     spPropChangeParams.ClassInstallHeader.cbSize = sizeof(SP_CLASSINSTALL_HEADER); spPropChangeParams.ClassInstallHeader.InstallFunction = DIF_PROPERTYCHANGE; spPropChangeParams.Scope = DICS_FLAG_GLOBAL; spPropChangeParams.HwProfile = 0;  spPropChangeParams.StateChange = DICS_DISABLE;  SetupDiSetClassInstallParams(hDeviceInfo, &amp;device.getDeviceInfoData(), (SP_CLASSINSTALL_HEADER*)&amp;spPropChangeParams, sizeof(spPropChangeParams)); </code></pre>  <p>Actually I mixed and matched too many ways these structs and function I changed variable types of structs and parameter types of function at the end I could not get anything but error. I cannot find what is my mistake. Could you please help me solve this.</p>  <p>Thanks in advance!</p>