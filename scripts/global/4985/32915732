<p>I am doing a very interesting Computer Vision project which talks about how to "create manually" images with Matlab.</p>  <p>The teacher gave me three matrices: the <strong>illuminant matrix (called E)</strong>, the <strong>camera sensitivity matrix (called R)</strong> and finally, the <strong>surface reflectance matrix (called S)</strong>. The matrix dimensions are as follows:</p>  <p><strong>S: 31x512x512 (reflectance samples x <em>x-dimension</em> x <em>y-dimension</em>) R: 31x3 E: 31x1</strong></p>  <p>The teacher gave me also the following relationship: </p>  <p><strong>P=transpose(C)*R=transpose(S)*diagonal(E)*R</strong></p>  <p>Where <strong>C is the color matrix</strong>. Where <strong>P is the sensor response matrix</strong>.</p>  <p>The goal is to display the image formed by all the previous matrices. Therefore, we have to compute the P matrix.</p>  <p>The class of all the matrices is <strong>double</strong>.</p>  <p>This is what I have done:</p>  <pre><code>Diag_D=diag(D);% Diagonal matrix of D   S_reshaped= reshape(S,31,[512*512]);% Reshape the surface reflectance matrix S_permute=permute(S_reshaped,[2 1]);% The output matrix is a 262144x31 matrix  Color_Signal_D65_buffer=S_permute*Diag_DD; Color_Signal_D65=reshape(Color_Signal_D65_buffer,[512 512 31]);% This is the final color matrix  Image_D65_buffer= (reshape(Color_Signal_D65,[512*512],31))*R;% Apply the given formula Image_D65= reshape(Image_D65_buffer,[512 512 3]);% image formation Image_D65_norm=sqrt(sum(Image_D65.^2,3));% Compute the Image_D65 norm    Image_D65_Normalized=bsxfun(@rdivide, Image_D65, Image_D65_norm);% Divide each element of the matrix by the norm in order to normalize the matrix  figure imshow(Image_D65_Normalized)% Display the image </code></pre>  <p>However,it did not work at all. The output is an image but the colors are completely wrong (there is too much blue on the image). I think it could be a matrix reshaping problem but I have tried all the possible combinations but nothing to do.</p>  <p>Thank you so much for your help</p>